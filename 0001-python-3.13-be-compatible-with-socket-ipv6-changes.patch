From e6572f68806922e98222dd829a5fa060205c16d2 Mon Sep 17 00:00:00 2001
From: Michael Webster <miketwebster@gmail.com>
Date: Thu, 15 Jan 2026 10:17:43 -0500
Subject: [PATCH] python 3.13: be compatible with socket ipv6 changes.

---
 src/remote_registration.py | 20 +++++++++++++++++---
 src/util.py                |  4 +++-
 2 files changed, 20 insertions(+), 4 deletions(-)

diff --git a/src/remote_registration.py b/src/remote_registration.py
index 2f0275cf..2f419f7b 100644
--- a/src/remote_registration.py
+++ b/src/remote_registration.py
@@ -14,6 +14,15 @@ import util
 import prefs
 import config
 
+def get_ipv6_addr_tuple(addr, port):
+    if '%' in addr:
+        ip_part, scope_name = addr.split('%', 1)
+        scope_id = socket.if_nametoindex(scope_name)
+    else:
+        ip_part = addr
+        scope_id = 0
+    return (ip_part, port, 0, scope_id)
+
 class RegRequest():
     def __init__(self, ident, hostname, ip_info, port, auth_port, api_version):
         self.api_version = api_version
@@ -142,10 +151,12 @@ class Request():
         remote_ip, _, ip_version = self.ip_info.get_usable_ip()
 
         try:
-            ip = remote_ip if ip_version == socket.AF_INET else "[%s]" % (remote_ip,)
             server_sock = socket.socket(ip_version, socket.SOCK_DGRAM)
             server_sock.settimeout(5.0)
-            server_sock.sendto(REQUEST, (ip, self.port))
+            if ip_version == socket.AF_INET6:
+                server_sock.sendto(REQUEST, get_ipv6_addr_tuple(remote_ip, self.port))
+            else:
+                server_sock.sendto(REQUEST, (remote_ip, self.port))
 
             reply, addr = server_sock.recvfrom(2000)
 
@@ -182,7 +193,10 @@ class RegistrationServer_v1():
             try:
                 server_sock = socket.socket(ip_version, socket.SOCK_DGRAM)
                 server_sock.settimeout(1.0)
-                server_sock.bind((local_ip, self.port))
+                if ip_version == socket.AF_INET6:
+                    server_sock.bind(get_ipv6_addr_tuple(local_ip, self.port))
+                else:
+                    server_sock.bind((local_ip, self.port))
             except socket.error as e:
                 logging.critical("Could not create udp socket for cert requests: %s" % str(e))
                 return
diff --git a/src/util.py b/src/util.py
index 7fb73909..ef237632 100644
--- a/src/util.py
+++ b/src/util.py
@@ -243,7 +243,9 @@ class InterfaceInfo():
                 pass
         if self.ip6:
             try:
-                blist.append(socket.inet_pton(GLib.SYSDEF_AF_INET6, self.ip6_address))
+                # Strip scope ID suffix if present (e.g., %eth0)
+                ip6_clean = self.ip6_address.split('%')[0] if '%' in self.ip6_address else self.ip6_address
+                blist.append(socket.inet_pton(GLib.SYSDEF_AF_INET6, ip6_clean))
             except:
                 pass
 
-- 
2.52.0

